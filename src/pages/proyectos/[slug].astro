---
import type { GetStaticPaths } from "astro";
import { getCollection, render } from "astro:content";

// Components
import GaleriaProyecto from "../../components/proyectos/GaleriaProyecto.astro";
import HeroProyecto from "../../components/proyectos/HeroProyecto.astro";
import TecnologiasSeccion from "../../components/proyectos/TecnologiasSeccion.astro";
import DetallesProyecto from "../../components/proyectos/DetallesProyecto.astro";
import NavegacionProyectos from "../../components/proyectos/NavegacionProyectos.astro";
import MetadatosProyecto from "../../components/proyectos/MetadatosProyecto.astro";

// Layout
import BaseLayout from "../../layouts/BaseLayout.astro";

const { slug } = Astro.params;

// Obtiene todos los proyectos
const proyectos = await getCollection("proyectos");

// Busca el proyecto por slug
const proyecto = proyectos.find((proj) => proj.slug === slug);

if (!proyecto) {
  throw new Error(`Proyecto con slug "${slug}" no encontrado.`);
}

// Define las rutas dinámicas que se generan en build
export const getStaticPaths: GetStaticPaths = async () => {
  const proyectos = await getCollection("proyectos");
  return proyectos.map((proyecto) => ({
    params: { slug: proyecto.slug },
    props: { proyecto },
  }));
};

const { Content } = await render(proyecto);
const { 
  titulo, 
  descripcion, 
  tecnologias, 
  portada, 
  imagenes,
  caracteristicas,
  desafios,
  aprendizajes,
  fecha,
  estado,
  repositorio,
  demo
} = proyecto.data;

const listaImagenes = imagenes.map((src, idx) => ({
  src,
  alt: `Imagen ${idx + 1} del proyecto ${titulo}`,
}));

---

<BaseLayout title={proyecto.data.titulo}>
  <!-- Hero Section -->
  <HeroProyecto 
    titulo={titulo} 
    descripcion={descripcion} 
    tecnologias={tecnologias} 
    portada={portada} 
    slug={proyecto.slug}
    fecha={fecha}
    estado={estado}
    repositorio={repositorio}
    demo={demo}
  />
  
    <!-- Sección de Tecnologías -->
    <TecnologiasSeccion 
    tecnologias={tecnologias} 
    slug={proyecto.slug}
  />
  
  <!-- Galería de Imágenes -->
  <GaleriaProyecto imagenes={listaImagenes} />
  
  <section class="py-12">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 markdown-card">
      <article class="markdown-content">
        <Content />
      </article>
    </div>
  </section>
  
  <!-- Detalles del Proyecto -->
  <DetallesProyecto 
    caracteristicas={caracteristicas}
    desafios={desafios}
    aprendizajes={aprendizajes}
  />
  
  <!-- Navegación a Otros Proyectos -->
  <NavegacionProyectos />
</BaseLayout>
